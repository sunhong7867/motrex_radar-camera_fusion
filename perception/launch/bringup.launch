<launch>
  <!-- =========================
       Global args (나중에 수정/리맵)
       ========================= -->
  <arg name="image_topic"       default="/camera/image_raw" />
  <arg name="camera_info_topic" default="/camera/camera_info" />
  <arg name="radar_topic"       default="/point_cloud" />

  <!-- 결과 토픽(고정 추천) -->
  <arg name="detections_topic"     default="/perception/detections" />
  <arg name="detections_roi_topic" default="/perception/detections_roi" />
  <arg name="tracks_topic"         default="/perception/tracks" />
  <arg name="assoc_topic"          default="/perception/associated" />
  <arg name="assoc_speed_topic"    default="/perception/associated_speed" />

  <!-- config paths -->
  <arg name="detector_yaml"   default="$(find perception)/config/detector.yaml" />
  <arg name="roi_lanes_yaml"  default="$(find perception)/config/roi_lanes.yaml" />
  <arg name="intrinsic_yaml"  default="$(find perception)/config/camera_intrinsic.yaml" />
  <arg name="extrinsic_yaml"  default="$(find perception)/config/camera_radar_extrinsic.yaml" />

  <!-- json들은 nodes 폴더에 있다고 했으니 그 기준 -->
  <arg name="extrinsic_json"  default="$(find perception)/src/nodes/extrinsic.json" />
  <arg name="lane_polys_json" default="$(find perception)/src/nodes/lane_polys.json" />

  <!-- =========================
       1) Object Detector
       ========================= -->
  <node pkg="perception" type="object_detector_node.py" name="object_detector" output="screen">
    <!-- 입력/출력 토픽 -->
    <param name="image_topic" value="$(arg image_topic)" />
    <param name="camera_info_topic" value="$(arg camera_info_topic)" />
    <param name="out_topic" value="$(arg detections_topic)" />

    <!-- detector 설정 -->
    <rosparam command="load" file="$(arg detector_yaml)" />
  </node>

  <!-- =========================
       2) Lane ROI Filter
       (detector 결과를 차선 ROI로 필터)
       ========================= -->
  <node pkg="perception" type="lane_detector_node.py" name="lane_detector" output="screen">
    <param name="in_topic" value="$(arg detections_topic)" />
    <param name="out_topic" value="$(arg detections_roi_topic)" />
    <param name="roi_yaml_path" value="$(arg roi_lanes_yaml)" />
    <param name="lane_polys_json" value="$(arg lane_polys_json)" />

    <rosparam command="load" file="$(arg roi_lanes_yaml)" />
  </node>

  <!-- =========================
       3) Tracker (IoU 기반)
       ========================= -->
  <node pkg="perception" type="tracker_node.py" name="tracker" output="screen">
    <param name="in_topic" value="$(arg detections_roi_topic)" />
    <param name="out_topic" value="$(arg tracks_topic)" />
  </node>

  <!-- =========================
       4) Association
       (bbox 내부 레이더 점 선택 + dist/speed raw 산출)
       ========================= -->
  <node pkg="perception" type="association_node.py" name="association" output="screen">
    <param name="radar_topic" value="$(arg radar_topic)" />
    <param name="bbox_topic" value="$(arg tracks_topic)" />
    <param name="out_topic" value="$(arg assoc_topic)" />

    <!-- 카메라/외부파라미터 -->
    <param name="camera_info_topic" value="$(arg camera_info_topic)" />
    <param name="intrinsic_yaml" value="$(arg intrinsic_yaml)" />
    <param name="extrinsic_yaml" value="$(arg extrinsic_yaml)" />
    <param name="extrinsic_json" value="$(arg extrinsic_json)" />

    <!-- (선택) 디버그용 마커 -->
    <param name="publish_markers" value="true" />
    <param name="markers_topic" value="/perception/association_markers" />
  </node>

  <!-- =========================
       5) Speed Estimator
       (gate + bias + kalman)
       ========================= -->
  <node pkg="perception" type="speed_estimator_node.py" name="speed_estimator" output="screen">
    <param name="in_topic" value="$(arg assoc_topic)" />
    <param name="out_topic" value="$(arg assoc_speed_topic)" />

    <!-- 기본 튜닝값: CARLA 느낌 유지 -->
    <param name="gate/min_dist_m" value="25.0" />
    <param name="gate/min_points" value="3" />

    <param name="bias/enable" value="true" />
    <!-- bias segments: 필요하면 여기서 바꾸면 됨 -->
    <rosparam param="bias/segments">
      - {max_dist: 25.0, bias_kph: -0.82}
      - {max_dist: 35.0, bias_kph: -0.48}
      - {max_dist: 1e9,  bias_kph: -0.41}
    </rosparam>

    <param name="kf/enable" value="true" />
    <param name="kf/q" value="0.05" />
    <param name="kf/r" value="6.0" />
    <param name="track_timeout_sec" value="2.0" />

    <param name="debug/enable" value="true" />
    <param name="debug/topic" value="/perception/speed_debug" />
  </node>

</launch>
