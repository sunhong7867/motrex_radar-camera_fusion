<launch>
    <arg name="detector_yaml" default="$(find perception_test)/config/detector.yaml" />
    <arg name="roi_lanes_yaml" default="$(find perception_test)/config/roi_lanes.yaml" />
    
    <node pkg="perception_test" type="offline_provider.py" name="offline_provider" output="screen">
        <param name="bag_path" value="$(find perception_test)/models/my_test_data.bag" />
        
        <param name="intrinsic_path" value="$(find perception_test)/config/camera_intrinsic.yaml" />
        
        <param name="bag_image_topic" value="/camera/image_raw" />
        <param name="bag_radar_topic" value="/point_cloud" />
        
        <param name="out_image_topic" value="/camera/image_raw" />
        <param name="out_radar_topic" value="/point_cloud" />
        <param name="out_info_topic" value="/camera/camera_info" />
    </node>

    <node pkg="perception_test" type="object_detector_node.py" name="object_detector" output="screen">
        <rosparam command="load" file="$(arg detector_yaml)" />
        <param name="topics/image_in" value="/camera/image_raw" />
        <param name="topics/detections_out" value="/perception_test/detections_raw" />
    </node>

    <node pkg="perception_test" type="lane_detector_node.py" name="lane_detector" output="screen">
        <rosparam command="load" file="$(arg roi_lanes_yaml)" />
        <param name="input_topic" value="/perception_test/detections_raw" />
        <param name="output_topic" value="/perception_test/detections" />
        <param name="roi_source/path" value="$(find perception_test)/src/nodes/lane_polys.json" />
    </node>

    <node pkg="perception_test" type="tracker_node.py" name="tracker" output="screen">
        <param name="in_topic" value="/perception_test/detections" />
        <param name="out_topic" value="/perception_test/tracks" />
        <param name="iou_threshold" value="0.3" />
    </node>

    <node pkg="perception_test" type="association_node.py" name="association" output="screen">
        <param name="radar/pointcloud_topic" value="/point_cloud" />
        <param name="bbox_topic" value="/perception_test/tracks" />
        <param name="associated_topic" value="/perception_test/associated" />
        <param name="extrinsic_source/path" value="$(find perception_test)/config/extrinsic.json" />
    </node>

    <node pkg="perception_test" type="speed_estimator_node.py" name="speed_estimator" output="screen">
        <param name="in_topic" value="/perception_test/associated" />
        <param name="out_topic" value="/perception_test/output" />
        <param name="gate/min_speed_kph" value="0.0" />
    </node>

    <node pkg="perception_test" type="calibration_in_node.py" name="cam_intrinsic_calib" output="screen">
    <param name="camera_topic" value="/camera/image_raw"/>
    <param name="board/width" value="7"/>
    <param name="board/height" value="5"/>
    <param name="board/square_size" value="0.10"/>
    <param name="min_samples" value="30"/>
    <param name="output_path" value="$(find perception_test)/config/camera_intrinsic.yaml"/>
    <param name="save_images/enable" value="true"/>
    <param name="save_images/path" value="$(find perception_test)/calibration_images"/>
  </node>

  <node pkg="perception_test" type="calibration_ex_node.py" name="radar_cam_extrinsic" output="screen">
    <param name="detections_topic" value="/perception_test/detections"/>
    <param name="radar_topic" value="/point_cloud"/>
    <param name="camera_info_topic" value="/camera/camera_info"/>
    <param name="extrinsic_path" value="$(find perception_test)/config/extrinsic.json"/>
    <param name="min_samples" value="30"/>
    <param name="detection_threshold" value="0.5"/>
    <param name="min_range_m" value="5.0"/>
    <param name="min_power" value="0.0"/>
    <param name="sync_queue_size" value="10"/>
    <param name="sync_slop" value="0.1"/>
  </node>
</launch>