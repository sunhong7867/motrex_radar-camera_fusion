<launch>
    <arg name="detector_yaml" default="$(find autocal)/config/detector.yaml" />
    <arg name="roi_lanes_yaml" default="$(find autocal)/config/roi_lanes.yaml" />
    <arg name="image_topic" default="/camera/image_raw" />
    <arg name="radar_topic" default="/point_cloud" />
    <arg name="offline_sources_json" default="$(find autocal)/config/offline_sources.json" />
    <arg name="offline_source_name" default="default" />
    <arg name="launch_real_gui" default="true" />

    <!-- Rosbag 모드: 아래 offline_provider 노드를 켭니다. -->
    <node pkg="autocal" type="offline_provider_node.py" name="offline_provider" output="screen">
        <param name="sources_json" value="$(arg offline_sources_json)" />
        <param name="source_name" value="$(arg offline_source_name)" />
        <param name="out_image_topic" value="$(arg image_topic)" />
        <param name="out_radar_topic" value="$(arg radar_topic)" />
    </node>

    <!-- 실센서 모드: 위 offline_provider 노드 블록을 XML 주석으로 감싸 비활성화하면 됩니다. -->

    <node pkg="autocal" type="object_detector_node.py" name="object_detector" output="screen">
        <rosparam command="load" file="$(arg detector_yaml)" />
        <param name="topics/image_in" value="$(arg image_topic)" />
        <param name="topics/detections_out" value="/autocal/detections_raw" />
    </node>

    <node pkg="autocal" type="lane_detector_node.py" name="lane_detector" output="screen">
        <rosparam command="load" file="$(arg roi_lanes_yaml)" />
        <param name="input_topic" value="/autocal/detections_raw" />
        <param name="output_topic" value="/autocal/detections" />
        <param name="roi_source/path" value="$(find autocal)/src/nodes/lane_polys.json" />
    </node>

    <node pkg="autocal" type="tracker_node.py" name="tracker" output="screen">
        <param name="in_topic" value="/autocal/detections" />
        <param name="out_topic" value="/autocal/tracks" />
        <param name="iou_threshold" value="0.3" />
    </node>

    <node pkg="autocal" type="association_node.py" name="association" output="screen">
        <param name="radar/pointcloud_topic" value="$(arg radar_topic)" />
        <param name="bbox_topic" value="/autocal/tracks" />
        <param name="associated_topic" value="/autocal/associated" />
        <param name="extrinsic_path" value="$(find autocal)/config/extrinsic.json" />
    </node>

    <node pkg="autocal" type="speed_estimator_node.py" name="speed_estimator" output="screen">
        <param name="in_topic" value="/autocal/associated" />
        <param name="out_topic" value="/autocal/output" />
        <param name="gate/min_speed_kph" value="0.0" />
    </node>

    <node pkg="autocal" type="calibration_in_node.py" name="cam_intrinsic_calib" output="screen">
        <param name="camera_topic" value="$(arg image_topic)"/>
        <param name="board/width" value="7"/>
        <param name="board/height" value="5"/>
        <param name="board/square_size" value="0.10"/>
        <param name="min_samples" value="30"/>
        <param name="output_path" value="$(find autocal)/config/camera_intrinsic.yaml"/>
        <param name="save_images/enable" value="true"/>
        <param name="save_images/path" value="$(find autocal)/calibration_images"/>
    </node>

    <node pkg="autocal" type="calibration_diagnosis_node.py" name="trajectory_eval" output="screen" />
    <node if="$(arg launch_real_gui)" pkg="autocal" type="real_gui.py" name="real_gui" output="screen" />
</launch>